name: Publish to Hex.pm

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  publish:
    name: Publish to Hex.pm
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        with:
          otp-version: "27"
          rebar3-version: "3"

      - name: Verify version matches release tag
        run: |
          TAG_VERSION="${{ github.event.release.tag_name }}"
          TAG_VERSION="${TAG_VERSION#v}"

          # Validate semver format: X.Y.Z or X.Y.Z-prerelease
          SEMVER_REGEX='^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\.[a-zA-Z0-9]+)*)?$'
          if ! echo "$TAG_VERSION" | grep -qE "$SEMVER_REGEX"; then
            echo "::error::Invalid semver tag: $TAG_VERSION (expected: X.Y.Z or X.Y.Z-pre.release)"
            exit 1
          fi

          APP_VERSION=$(grep '{vsn,' src/ocibuild.app.src | sed 's/.*{vsn, *"\([^"]*\)".*/\1/')

          echo "app.src version: $APP_VERSION"
          echo "Release tag: $TAG_VERSION"

          if [ "$APP_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::Version mismatch! Update app.src to $TAG_VERSION before releasing."
            exit 1
          fi

      - name: Publish to Hex.pm
        env:
          HEX_API_KEY: ${{ secrets.HEX_API_KEY }}
        run: rebar3 hex publish --yes
