name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "LICENSE*"
      - ".gitignore"
      - ".editorconfig"
      - "docs/**"
      - ".github/workflows/docs.yaml"
      - ".github/workflows/publish.yaml"
      - ".github/ISSUE_TEMPLATE/**"
      - ".github/PULL_REQUEST_TEMPLATE/**"
      - ".github/CODEOWNERS"
      - ".github/FUNDING.yml"
      - ".github/dependabot.yml"
  pull_request:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "LICENSE*"
      - ".gitignore"
      - ".editorconfig"
      - "docs/**"
      - ".github/workflows/docs.yaml"
      - ".github/workflows/publish.yaml"
      - ".github/ISSUE_TEMPLATE/**"
      - ".github/PULL_REQUEST_TEMPLATE/**"
      - ".github/CODEOWNERS"
      - ".github/FUNDING.yml"
      - ".github/dependabot.yml"

permissions:
  contents: read
  packages: write

jobs:
  test-erlang:
    name: Erlang Tests (OTP ${{ matrix.otp }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        otp: ["27", "28"]

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        with:
          otp-version: ${{ matrix.otp }}
          rebar3-version: "3"

      - name: Cache rebar3 dependencies
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: |
            _build
            ~/.cache/rebar3
          key: ${{ runner.os }}-rebar3-otp${{ matrix.otp }}-${{ hashFiles('rebar.lock') }}
          restore-keys: |
            ${{ runner.os }}-rebar3-otp${{ matrix.otp }}-

      - name: Compile
        run: rebar3 compile

      - name: Run tests with coverage
        run: |
          rebar3 eunit
          rebar3 cover --verbose

  test-elixir:
    name: Elixir Tests (OTP ${{ matrix.otp }} / Elixir ${{ matrix.elixir }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        otp: ["27", "28"]
        elixir: ["1.19"]

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Erlang/OTP and Elixir
        uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        with:
          otp-version: ${{ matrix.otp }}
          elixir-version: ${{ matrix.elixir }}
          rebar3-version: "3"

      - name: Cache Mix dependencies
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-otp${{ matrix.otp }}-elixir${{ matrix.elixir }}-${{ hashFiles('mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-otp${{ matrix.otp }}-elixir${{ matrix.elixir }}-

      - name: Get dependencies
        run: mix deps.get

      - name: Run tests
        run: mix test

  integration:
    name: Integration Test (Phoenix)
    runs-on: ubuntu-24.04
    needs: [test-erlang, test-elixir]

    steps:
      - name: Checkout ocibuild
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          path: ocibuild

      - name: Setup Erlang/OTP and Elixir
        uses: erlef/setup-beam@e6d7c94229049569db56a7ad5a540c051a010af9 # v1.20.4
        with:
          otp-version: "28"
          elixir-version: "1.19"
          rebar3-version: "3"

      - name: Cache Mix dependencies
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-integration-otp28-elixir1.19-${{ hashFiles('ocibuild/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-integration-otp28-elixir1.19-

      - name: Cache OCI layers
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: test_app/_build/ocibuild_cache
          key: ocibuild-layers-${{ runner.os }}

      - name: Install Phoenix generator
        run: mix archive.install hex phx_new --force

      - name: Create Phoenix project
        run: |
          yes | mix phx.new test_app --no-ecto --no-mailer --no-dashboard --no-live --no-install

      - name: Configure ocibuild dependency
        working-directory: test_app
        run: |
          # Add ocibuild as a path dependency using Elixir
          elixir -e '
            content = File.read!("mix.exs")

            # Add ocibuild to deps
            content = String.replace(content, "defp deps do\n    [", "defp deps do\n    [\n      {:ocibuild, path: \"../ocibuild\"},")

            # Add ocibuild config to project (ubuntu:noble has glibc 2.39, compatible with OTP 28 from ubuntu 24.04 runner)
            content = String.replace(content, "def project do\n    [", "def project do\n    [\n      ocibuild: [base_image: \"ubuntu:noble\"],")

            File.write!("mix.exs", content)
            IO.puts("Updated mix.exs with ocibuild configuration")
          '

      - name: Get dependencies
        working-directory: test_app
        run: mix deps.get

      - name: Compile application
        working-directory: test_app
        run: MIX_ENV=prod mix compile

      - name: Build release
        working-directory: test_app
        run: MIX_ENV=prod mix release

      - name: Build and push OCI image
        working-directory: test_app
        env:
          OCIBUILD_PUSH_USERNAME: ${{ github.actor }}
          OCIBUILD_PUSH_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
          # Use exact repository name for package (auto-links to repo, required for GITHUB_TOKEN)
          IMAGE_NAME: ${{ github.repository }}
        run: |
          IMAGE_NAME_LOWER=$(echo "$IMAGE_NAME" | tr '[:upper:]' '[:lower:]')
          MIX_ENV=prod mix ocibuild \
            -t "${IMAGE_NAME_LOWER}:integration" \
            -d "CI workflow test image" \
            --push ghcr.io

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull image
        env:
          IMAGE_NAME: ${{ github.repository }}
        run: |
          IMAGE_NAME_LOWER=$(echo "$IMAGE_NAME" | tr '[:upper:]' '[:lower:]')
          docker pull "ghcr.io/${IMAGE_NAME_LOWER}:integration"
          docker images "ghcr.io/${IMAGE_NAME_LOWER}:integration"

      - name: Run container
        working-directory: test_app
        env:
          IMAGE_NAME: ${{ github.repository }}
        run: |
          IMAGE_NAME_LOWER=$(echo "$IMAGE_NAME" | tr '[:upper:]' '[:lower:]')

          # Start container in background
          docker run -d --name test-app \
            -p 4000:4000 \
            -e SECRET_KEY_BASE="$(mix phx.gen.secret)" \
            -e PHX_HOST=localhost \
            -e PHX_SERVER=true \
            "ghcr.io/${IMAGE_NAME_LOWER}:integration"

          # Wait for app to start
          sleep 5

          # Check container is still running
          if ! docker ps | grep test-app; then
            echo "Container stopped unexpectedly:"
            docker logs test-app
            exit 1
          fi

          # Check app responds
          curl -f http://localhost:4000 || (docker logs test-app && exit 1)

          # Cleanup
          docker stop test-app

      - name: Delete test image from GHCR
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get package name (repo name, lowercase)
          PACKAGE_NAME=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')

          # Find version ID for the integration tag
          VERSION_ID=$(gh api \
            "/orgs/${{ github.repository_owner }}/packages/container/${PACKAGE_NAME}/versions" \
            --jq '.[] | select(.metadata.container.tags | index("integration")) | .id' \
            2>/dev/null || echo "")

          if [ -n "$VERSION_ID" ]; then
            echo "Deleting package version $VERSION_ID (tag: integration)"
            gh api --method DELETE \
              "/orgs/${{ github.repository_owner }}/packages/container/${PACKAGE_NAME}/versions/${VERSION_ID}" \
              || echo "Failed to delete package (may require admin permissions)"
          else
            echo "No integration image found to delete"
          fi
